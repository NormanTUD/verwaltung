{% extends "base.html" %}

{% block content %}
    <h1>CouchDB Dokumente</h1>

    <button onclick="addRow()">Neue Zeile</button>
    <button onclick="addColumn()">Spalte erweitern</button>

    {% if docs %}  <-- Add this check here!
    <table>
        <thead>
            <tr>
                <th>ID</th>
                {% for key in docs[0].keys() %}
                    {% if key not in ['_id', '_rev'] %}
                        <th>{{ key }}</th>
                    {% endif %}
                {% endfor %}
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in docs %}
                <tr data-doc-id="{{ doc._id }}">
                    <td>{{ doc._id }}</td>
                    {% for key in docs[0].keys() %}
                        {% if key not in ['_id', '_rev'] %}
                            <td contenteditable="true">{{ doc[key] }}</td>
                        {% endif %}
                    {% endfor %}
                    <td>
                        <button onclick="deleteRow('{{ doc._id }}')">Löschen</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>Keine Dokumente in der Datenbank gefunden. Füge eine neue Zeile hinzu, um zu starten.</p>
    {% endif %}

    <script>
        function addRow() {
            const data = {};
            const keys = Array.from(document.querySelectorAll('thead th')).map(th => th.textContent.trim());
            
            keys.forEach(key => {
                if (key !== 'ID' && key !== 'Aktionen') {
                    data[key] = prompt(`Wert für '${key}':`);
                }
            });

            fetch('/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Fehler beim Erstellen.');
                }
            });
        }

        function deleteRow(docId) {
            if (confirm("Sicher löschen?")) {
                fetch(`/delete/${docId}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Fehler beim Löschen.');
                    }
                });
            }
        }

	function addColumn() {
		const colName = prompt("Name der neuen Spalte:");
		if (!colName) {
			return;
		}

		// Backend-Aufruf, um die Spalte zu den Dokumenten hinzuzufügen
		fetch('/add_column', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ column_name: colName })
		}).then(response => {
			if (response.ok) {
				// Bei Erfolg die Seite neu laden, um die aktualisierte Tabelle zu sehen
				location.reload();
			} else {
				alert('Fehler beim Hinzufügen der Spalte.');
			}
		});
	}

	// Funktion zum Hinzufügen von Werten
	function addRow() {
		const data = {};
		const keys = Array.from(document.querySelectorAll('thead th')).map(th => th.textContent.trim());

		keys.forEach(key => {
			if (key !== 'ID' && key !== 'Aktionen' && key) {
				data[key] = prompt(`Wert für '${key}':`);
			}
		});

		// Überprüfen, ob Daten eingegeben wurden, bevor eine Anfrage gesendet wird
		const hasData = Object.values(data).some(value => value !== null && value !== "");
		if (hasData) {
			fetch('/create', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data)
			}).then(response => {
				if (response.ok) {
					location.reload();
				} else {
					alert('Fehler beim Erstellen.');
				}
			});
		}
	}
    </script>
{% endblock %}
