{% extends "base.html" %}

{% block content %}
    <h1>CouchDB Dokumente</h1>

    <button onclick="addRow()">Neue Zeile</button>
    <button onclick="addColumn()">Spalte erweitern</button>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                {% for key in docs[0].keys() %}
                    {% if key not in ['_id', '_rev'] %}
                        <th>{{ key }}</th>
                    {% endif %}
                {% endfor %}
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in docs %}
                <tr data-doc-id="{{ doc._id }}">
                    <td>{{ doc._id }}</td>
                    {% for key in docs[0].keys() %}
                        {% if key not in ['_id', '_rev'] %}
                            <td contenteditable="true">{{ doc[key] }}</td>
                        {% endif %}
                    {% endfor %}
                    <td>
                        <button onclick="deleteRow('{{ doc._id }}')">Löschen</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        function addRow() {
            const data = {};
            const keys = Array.from(document.querySelectorAll('thead th')).map(th => th.textContent.trim());
            
            keys.forEach(key => {
                if (key !== 'ID' && key !== 'Aktionen') {
                    data[key] = prompt(`Wert für '${key}':`);
                }
            });

            fetch('/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Fehler beim Erstellen.');
                }
            });
        }

        function deleteRow(docId) {
            if (confirm("Sicher löschen?")) {
                fetch(`/delete/${docId}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Fehler beim Löschen.');
                    }
                });
            }
        }
        
        // Logik für die dynamische Spalten- und Zellbearbeitung muss hier implementiert werden.
        // Bei `contenteditable="true"` musst du einen Event-Listener hinzufügen, der die Änderungen erkennt und an das Backend sendet.
        // Beispiel: addEventListener('input', ...), wenn der Fokus eine Zelle verlässt.
    </script>
{% endblock %}
