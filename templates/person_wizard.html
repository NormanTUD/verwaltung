{% extends "layout.html" %}
{% block title %}Person erstellen{% endblock %}
{% block content %}
<h1>Person anlegen</h1>
<form method="post" id="person-form">
  <table class="table" style="width: 100%; table-layout: fixed;">
    <tbody>
      <tr>
        <td style="width: 15%;">
          <label for="title" class="form-label">Titel</label>
        </td>
        <td style="width: 35%;">
          <input type="text" class="form-control" id="title" name="title"
                 placeholder="Titel eingeben"
                 value="{{ form_data.title | default('') }}">
        </td>
        <td style="width: 15%;">
          <label for="first_name" class="form-label">Vorname *</label>
        </td>
        <td style="width: 35%;">
          <input type="text" class="form-control" id="first_name" name="first_name" required
                 placeholder="Vorname eingeben"
                 value="{{ form_data.first_name | default('') }}">
        </td>
      </tr>
      <tr>
        <td>
          <label for="last_name" class="form-label">Nachname *</label>
        </td>
        <td>
          <input type="text" class="form-control" id="last_name" name="last_name" required
                 placeholder="Nachname eingeben"
                 value="{{ form_data.last_name | default('') }}">
        </td>
        <td>
          <label for="image_url" class="form-label">Bild URL</label>
        </td>
        <td>
          <input type="url" class="form-control" id="image_url" name="image_url"
                 placeholder="https://example.com/bild.jpg"
                 value="{{ form_data.image_url | default('') }}">
        </td>
      </tr>
      <tr>
        <td>
          <label for="comment" class="form-label">Kommentar</label>
        </td>
        <td colspan="3">
          <textarea class="form-control" id="comment" name="comment" placeholder="Kommentar eingeben" style="width: 100%;">{{ form_data.comment | default('') }}</textarea>
        </td>
      </tr>
    </tbody>
  </table>

  <hr />
  <h3>Kontakte (Emails, Telefon, Fax, Kommentar)</h3>
  <div id="contacts-container"></div>
  <button type="button" class="btn btn-secondary mb-3" id="add-contact-btn">+ Kontakt hinzuf체gen</button>

  <hr />
  <h3>Transponder</h3>
  <div id="transponder-container"></div>
  <button type="button" class="btn btn-secondary mb-3" id="add-transponder-btn">+ Transponder hinzuf체gen</button>

  <hr />
  <h3>R채ume (IDs)</h3>
  <div id="rooms-container"></div>
  <button type="button" class="btn btn-secondary mb-3" id="add-room-btn">+ Raum hinzuf체gen</button>

  <hr />
  <button type="submit" class="btn btn-primary save-new">Person speichern</button>
</form>

<script src="/static/jquery.min.js"></script>
<script src="/static/toastr.min.js"></script>
<script>
	function createContactRow(data = {}) {
		return $(`
		<div class="contact-row">
		    <div class="mb-2">
			<label>Email:</label>
			<input type="email" name="email[]" class="form-control" placeholder="Email"
			       value="${data.email || ''}">
		    </div>
		    <div class="mb-2">
			<label>Telefon:</label>
			<input type="text" name="phone[]" class="form-control" placeholder="Telefon"
			       value="${data.phone || ''}">
		    </div>
		    <div class="mb-2">
			<label>Fax:</label>
			<input type="text" name="fax[]" class="form-control" placeholder="Fax"
			       value="${data.fax || ''}">
		    </div>
		    <div class="mb-2">
			<label>Kommentar:</label>
			<input type="text" name="contact_comment[]" class="form-control" placeholder="Kommentar"
			       value="${data.comment || ''}">
		    </div>
		    <button type="button" class="btn btn-danger btn-sm remove-contact-btn delete-entry">Entfernen</button>
		</div>
	    `);
	}

	function createTransponderRow(data = {}) {
		return $(`
		<div class="transponder-row">
		    <div class="mb-2">
		        <label>Seriennummer:</label>
		        <input type="text" name="transponder_serial[]" class="form-control" placeholder="Seriennummer"
		               value="${data.serial || ''}">
		    </div>
		    <div class="mb-2">
		        <label>Kommentar:</label>
		        <input type="text" name="transponder_comment[]" class="form-control" placeholder="Kommentar"
		               value="${data.comment || ''}">
		    </div>
		    <button type="button" class="btn btn-danger btn-sm remove-transponder-btn">Entfernen</button>
		</div>
		`);
	}

	function createRoomRow(data = {}) {
		return $(`
		<div class="room-row">
		    <div class="mb-2">
		        <label>Raum ID:</label>
		        <input type="number" name="room_id[]" class="form-control" placeholder="Raum-ID (z.B. 42)" 
		               value="${data.id || ''}">
		    </div>
		    <button type="button" class="btn btn-danger btn-sm remove-room-btn">Entfernen</button>
		</div>
		`);
	}

	$(document).ready(function () {
		$('#add-contact-btn').on('click', function () {
			$('#contacts-container').append(createContactRow());
			applyInvertFilterToElements(theme);
		});

		$('#contacts-container').on('click', '.remove-contact-btn', function () {
			$(this).closest('.contact-row').remove();
		});

		$('#add-transponder-btn').on('click', function () {
			$('#transponder-container').append(createTransponderRow());
			applyInvertFilterToElements(theme);
		});

		$('#transponder-container').on('click', '.remove-transponder-btn', function () {
			$(this).closest('.transponder-row').remove();
		});

		$('#add-room-btn').on('click', function () {
			$('#rooms-container').append(createRoomRow());
			applyInvertFilterToElements(theme);
			replace_id_fields_with_proper_fields()
		});

		$('#rooms-container').on('click', '.remove-room-btn', function () {
			$(this).closest('.room-row').remove();
		});

		toastr.options = {
			closeButton: true,
			progressBar: true,
			positionClass: "toast-top-right",
			timeOut: "5000"
		};

		const success = {{ success | tojson }};
		const error = {{ error | tojson }};
		const formData = {{ form_data | tojson }};

		if (success) {
			toastr.success("Person erfolgreich gespeichert.");
			$('#person-form')[0].reset();
			$('#contacts-container').empty().append(createContactRow());
			$('#transponder-container').empty().append(createTransponderRow());
			$('#rooms-container').empty().append(createRoomRow());
		} else {
			if (error) {
				toastr.error("Fehler: " + error);
			}

			if (formData.contacts && formData.contacts.length > 0) {
				$('#contacts-container').empty();
				formData.contacts.forEach(contact => {
					$('#contacts-container').append(createContactRow(contact));
				});
			} else {
				$('#contacts-container').append(createContactRow());
			}

			if (formData.transponders && formData.transponders.length > 0) {
				$('#transponder-container').empty();
				formData.transponders.forEach(tp => {
					$('#transponder-container').append(createTransponderRow(tp));
				});
			} else {
				$('#transponder-container').append(createTransponderRow());
			}

			if (formData.rooms && formData.rooms.length > 0) {
				$('#rooms-container').empty();
				formData.rooms.forEach(room => {
					$('#rooms-container').append(createRoomRow(room));
				});
			} else {
				$('#rooms-container').append(createRoomRow());
			}
		}
	});
</script>
{% endblock %}
