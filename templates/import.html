{% if not request.headers.get('X-Requested-With') == 'XMLHttpRequest' %}
    {% extends "layout.html" %}
{% endif %}

{% block title %}Daten-Import{% endblock %}

{% block content %}
    <h1>Daten importieren</h1>

    <div class="preset-buttons">
        <h3>Vordefinierte Daten zum Testen einfügen:</h3>
	<button type="button" onclick="insertDefaultData('persons')">Personen</button>
	<button type="button" onclick="insertDefaultData('customers')">Kunden</button>
	<button type="button" onclick="insertDefaultData('orders')">Bestellungen</button>
	<button type="button" onclick="insertDefaultData('shipments')">Lieferungen</button>
    </div>

<form id="upload_form" action="/upload" method="post">
    <label for="data">Füge deine CSV/TSV-Daten hier ein:</label><br>
    <textarea id="data" name="data" rows="10" cols="80"
        placeholder="z.B.: vorname,nachname,gebäude,abkürzung"
        style="background-color: rgb(26, 32, 44); color: rgb(247, 250, 252); border: 1px solid rgb(61, 174, 233);"></textarea><br>
    <button type="submit"
        style="background-color: rgb(26, 32, 44); color: rgb(247, 250, 252); border: 1px solid rgb(61, 174, 233);">
        Upload &amp; Zuordnen
    </button>
</form>

<div id="upload_response"></div>

<script>
	$(document).ready(function () {

	    // Formular-Abfang
	    $(document).on("submit", "#upload_form", function (e) {
		try {
		    e.preventDefault();

		    var form = $(this);
		    var actionUrl = form.attr("action");
		    var method = form.attr("method") || "POST";

		    if (typeof actionUrl !== "string" || actionUrl.trim() === "") {
			console.error("AJAX-Upload: Ungültige action-URL.");
			return;
		    }

		    var mainContent = $("#main_content");
		    if (mainContent.length === 0) {
			console.error("AJAX-Upload: #main_content nicht gefunden.");
			return;
		    }

		    var formData = form.serialize();

		    // Spinner anzeigen
		    var spinnerHtml = '' +
			'<div id="ajax_spinner" style="display:flex;align-items:center;justify-content:center;height:100%;min-height:100px;">' +
			'  <div style="border:6px solid #f3f3f3;border-top:6px solid #3498db;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;"></div>' +
			'  <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>' +
			'</div>';
		    mainContent.html(spinnerHtml);

		    // AJAX-POST durchführen
		    $.ajax({
			url: actionUrl,
			type: method.toUpperCase(),
			data: formData,
			dataType: "html",
			cache: false,
			success: function (data, textStatus, jqXHR) {
			    try {
				if (typeof data !== "string" || data.trim() === "") {
				    console.warn("AJAX-Upload: Leere Antwort empfangen.");
				    mainContent.html("<div style='color:red;padding:10px;'>Fehler: Leere Antwort.</div>");
				    return;
				}

				// HTML-Inhalt parsen
				var parsed = $("<div>").html(data);
				var scripts = parsed.find("script");

				mainContent.html(parsed);

				// Skripte ausführen
				scripts.each(function () {
				    var script = $(this);
				    var src = script.attr("src");
				    var code = script.html();

				    try {
					if (src) {
					    $.ajax({
						url: src,
						dataType: "script",
						cache: true,
						async: false,
						error: function (xhr, status, err) {
						    console.error("Fehler beim Laden von Script:", src, status, err);
						}
					    });
					} else if (code.trim() !== "") {
					    $.globalEval(code);
					}
				    } catch (scriptError) {
					console.error("Fehler beim Ausführen eines Skripts:", scriptError);
				    }
				});

				// URL in History übernehmen
				if (window.history && window.history.pushState) {
				    window.history.pushState({ ajaxLoaded: true, url: actionUrl }, "", actionUrl);
				}

			    } catch (innerError) {
				console.error("AJAX-Upload: Fehler beim Verarbeiten des Inhalts:", innerError);
				mainContent.html("<div style='color:red;padding:10px;'>Fehler beim Verarbeiten des Inhalts.</div>");
			    }
			},
			error: function (jqXHR, textStatus, errorThrown) {
			    console.error("AJAX-Upload: Fehler beim Request:", textStatus, errorThrown);
			    var errorMsg = "<div style='color:red;padding:10px;'>Fehler beim Upload:<br>" +
				$("<div>").text(textStatus + ": " + errorThrown).html() + "</div>";
			    mainContent.html(errorMsg);
			}
		    });

		} catch (error) {
		    console.error("AJAX-Upload: Allgemeiner Fehler:", error);
		    $("#main_content").html("<div style='color:red;padding:10px;'>Ein unerwarteter Fehler ist aufgetreten.</div>");
		}
	    });
	});
	</script>


    <script src="static/import.js">
    </script>
{% endblock %}
