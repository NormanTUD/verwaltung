{% extends "layout.html" %}
{% block title %}Floorplan{% endblock %}
{% block content %}
<link rel="stylesheet" href="static/map.css">

<label for="buildingSelect">Gebäude:</label>
<select id="buildingSelect">
	<option value="">-- Bitte wählen --</option>
	{% for b_id in building_map.keys()|sort %}
	<option value="{{ b_id }}" {% if building_id==b_id %}selected{% endif %}>
		{{ building_names.get(b_id, "Unbekanntes Gebäude") }}
	</option>
	{% endfor %}
</select>

<label for="etageSelect">Etage:</label>
<select id="etageSelect" {% if not etage %}disabled{% endif %}>
	<option value="">-- Bitte wählen --</option>
	{% if building_id %}
	{% for f in building_map[building_id]|sort %}
	<option value="{{ f }}" {% if etage==f %}selected{% endif %}>{{ f }}</option>
	{% endfor %}
	{% endif %}
</select>
<br>

<button id="addPersonBtn">➕ Person hinzufügen</button>
<div id="personForm" style="display:none; margin-top: 20px;">
	<label>
		<input type="radio" name="mode" value="select" checked>
		Bestehende Person auswählen
	</label>

	<div id="selectPersonArea" style="margin-top: 10px;">
		<select id="existingPersonSelect"></select>
	</div>

	<form id="dynamicPersonForm" style="margin-top: 10px; display:none;"></form>

	<button id="confirmPersonBtn">Bestätigen</button>
	<button id="cancelPersonBtn" type="button">Abbrechen</button>
</div>


<button id="addBtn">➕ Objekt hinzufügen</button>

<div id="selectContainer" style="display:none; margin-top: 10px;">
	<label for="objektSelect">Wähle ein Objekt:</label><br>
	<select id="objektSelect">
		<option value="">-- Bitte wählen --</option>
	</select>
	<button id="saveSelectedBtn">Auswählen</button>
	<button id="cancelSelectBtn">Abbrechen</button>
</div>

<div id="selectedInfo" style="margin-top: 20px;"></div>

<div id="viewport">
	{% if image_url and image_width and image_height %}


	<div id="floorplan"
		style="background: url('{{ image_url }}'); width: {{ image_width }}px; height: {{ image_height }}px;">
	</div>
	{% else %}
	<p>Kein gültiger Gebäudeplan gefunden.</p>
	{% endif %}

	<div id="generatedObjectsContainer"></div>
</div>


<script>
	document.getElementById("buildingSelect").addEventListener("change", function () {
		let buildingId = this.value;
		let etageSelect = document.getElementById("etageSelect");
		etageSelect.innerHTML = '<option value="">-- Bitte wählen --</option>';

		if (!buildingId) {
			etageSelect.disabled = true;
			// Seite neu laden ohne Parameter (optional)
			window.location.href = window.location.pathname;
			return;
		}

		// Etagen aus building_map laden (aus Template-Variablen)
		const buildingMap = {{ building_map | tojson
	}};
	const etages = buildingMap[buildingId] || [];
	etages.sort((a, b) => a - b);

	for (let f of etages) {
		let opt = document.createElement("option");
		opt.value = f;
		opt.textContent = f;
		etageSelect.appendChild(opt);
	}
	etageSelect.disabled = false;
		});

	document.getElementById("etageSelect").addEventListener("change", function () {
		let etage = this.value;
		let buildingId = document.getElementById("buildingSelect").value;
		if (buildingId && etage) {
			window.location.href = `?building_id=${buildingId}&etage=${etage}`;
		}
	});
</script>


<script src="static/floorplan.js" defer></script>
{% endblock %}