#!/usr/bin/env bash

set -euo pipefail

venv_dir="$HOME/.neo4jtest"

log() {
	echo -e "\033[1;34m[INFO]\033[0m $*"
}

fail() {
	echo -e "\033[1;31m[ERROR]\033[0m $*"
	exit 1
}

cleanup() {
	log "Cleaning old coverage artifacts"
	rm -rf htmlcov .coverage coverage.xml || true
}

ensure_venv() {
	if [[ ! -d $venv_dir ]]; then
		log "Creating virtual environment in $venv_dir"
		python3 -m venv "$venv_dir"
	fi
	log "Activating virtual environment"
	# shellcheck disable=SC1090
	source "$venv_dir/bin/activate"
}

install_requirements() {
	log "Installing requirements"
	pip install -q -r requirements.txt || fail "pip install failed"
}

run_step() {
	local desc="$1"
	shift
	log "$desc"
	"$@" || fail "$desc failed"
}

find_missing_use_strict () {
	log "Finding missing 'use strict' in JS files"
	dir="${1:-.}"
	missing=$(find "$dir" -type d -name htmlcov -prune -o -type f -name "*.js" -exec grep -L -E "\"use strict\"|'use strict'" {} +)

	if [ -n "$missing" ]; then
		echo "Missing use strict in files:"
		echo "$missing"
		return 1
	fi
	return 0
}

main() {
	find_missing_use_strict

	ensure_venv
	install_requirements
	cleanup
	run_step "Running tests with coverage" coverage run test_app.py
	run_step "Generating HTML report" coverage html -i
	log "All steps completed successfully"
}

main "$@"
