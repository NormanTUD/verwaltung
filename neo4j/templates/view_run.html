{% extends "base.html" %}

{% block content %}
<style>
    .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .actions {
        display: flex;
        gap: 10px;
    }

    .actions button {
        background-color: #4CAF50; /* Green */
        border: none;
        color: white;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 50%; /* Makes it a circle */
        width: 30px;
        height: 30px;
        line-height: 30px;
        padding: 0;
        font-weight: bold;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    
    th {
        background-color: #f2f2f2;
        cursor: pointer;
    }
</style>

<div class="header-container">
    <h2>View results</h2>
    <div class="actions">
        <button id="add-column-btn" title="Add Column">+</button>
        <button id="add-row-btn" title="Add Row">+</button>
    </div>
</div>

<table id="results-table">
    <thead>
        <tr>
            {% set all_keys = [] %}
            {% if results %}
                {% set temp_keys = [] %}
                {% for row in results %}
                    {% for key in row.keys() %}
                        {% if key not in temp_keys and key != '__node_id' %}
                            {% set temp_keys = temp_keys + [key] %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                {% set all_keys = temp_keys %}
            {% endif %}
            {% for key in all_keys %}
                <th>{{ key }}</th>
            {% endfor %}
        </tr>
    </thead>
    
    <tbody>
        {% for row in results %}
            <tr>
                {% for key in all_keys %}
                    <td data-key="{{ key }}"
                        {% if row.get('__node_id') is not none %}data-node-id="{{ row['__node_id'] }}"{% endif %}
                        contenteditable="true">
                        {{ row[key] | default('', true) }}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
    </tbody>
</table>
  
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function(){
    // Update logic for editable cells
    $("#results-table td[contenteditable=true]").on("blur", function(){
        var td = $(this);
        var nodeId = td.data("node-id");
        var key = td.data("key");
        var newVal = td.text();

        if(!nodeId){
            console.warn("No node ID, skipping update for", key);
            return;
        }

        $.ajax({
            url: "/api/node/" + nodeId,
            method: "PATCH",
            contentType: "application/json",
            data: JSON.stringify({ [key]: newVal }),
            success: function(res){
                console.log("Updated", key, res);
            },
            error: function(xhr){
                alert("Update failed: " + xhr.responseText);
            }
        });
    });

    // Add new column
    $("#add-column-btn").on("click", function(){
        var propertyName = prompt("Spaltenname (Eigenschaftsname) eingeben:");
        if (propertyName) {
            $.ajax({
                url: "/add_column",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    view_id: "{{ view_id }}",
                    property_name: propertyName
                }),
                success: function(res){
                    alert(res.message);
                    window.location.reload(); // Reload to show the new column
                },
                error: function(xhr){
                    alert("Spalte konnte nicht hinzugefügt werden: " + xhr.responseText);
                }
            });
        }
    });
    
    // Add new row
    $("#add-row-btn").on("click", function(){
        var nodeLabel = prompt("Entitätslabel für die neue Zeile eingeben:");
        if (nodeLabel) {
            $.ajax({
                url: "/add_row",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    label: nodeLabel,
                    properties: {} // Start with empty properties
                }),
                success: function(res){
                    alert("Neue Zeile erfolgreich hinzugefügt!");
                    window.location.reload(); // Reload to show the new row
                },
                error: function(xhr){
                    alert("Zeile konnte nicht hinzugefügt werden: " + xhr.responseText);
                }
            });
        }
    });
});
</script>
{% endblock %}
