{% extends "base.html" %}
{% block content %}
<h2>Potential property merges</h2>
{% if suggestions %}
  <ul>
  {% for canon, lst in suggestions.items() %}
    <li>
      Canonical "{{ canon }}": 
      {% for item in lst %}
        <strong>{{ item.name }}</strong> ({{ item.count }}) 
      {% endfor %}
      <form class="merge-form" data-props="{{ lst|map(attribute='name')|list|join(',') }}">
        <label>Strategy:
          <select name="strategy">
            <option value="overwrite">overwrite (if main empty take other)</option>
            <option value="array">array (combine unique)</option>
            <option value="sum">sum (numbers)</option>
          </select>
        </label>
        <button type="button" class="do-merge">Merge</button>
      </form>
    </li>
  {% endfor %}
  </ul>
{% else %}
  <p>No group suggestions found.</p>
{% endif %}

<script>
$(function(){
  $(".do-merge").on("click", function(){
    var form = $(this).closest("form");
    var props = form.data("props").split(",");
    var strategy = form.find("select[name=strategy]").val();
    $.ajax({
      url: "/merge/merge_props",
      method: "POST",
      contentType: "application/json",
      data: JSON.stringify({ props: props, strategy: strategy }),
      success: function(res){ alert("Merge result: " + JSON.stringify(res)); location.reload(); },
      error: function(xhr){ alert("Error: " + xhr.responseText); }
    });
  });
});
</script>
{% endblock %}
