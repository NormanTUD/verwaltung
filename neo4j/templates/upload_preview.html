{% extends "base.html" %}
{% block content %}

<h1>CSV Preview ({{ rowcount }} rows)</h1>

<table class="table table-bordered table-sm">
  <thead>
    <tr>
      {% for col in columns %}
        <th>{{ col }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for row in preview %}
      <tr>
        {% for col in columns %}
          <td>{{ row[col] }}</td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>

<h2>Define Entities</h2>
<div id="entities"></div>
<button type="button" class="btn btn-primary btn-sm" onclick="addEntity()">+ Add Entity</button>

<h2>Define Relationships</h2>
<div id="relations"></div>
<button type="button" class="btn btn-secondary btn-sm" onclick="addRelation()">+ Add Relation</button>

<form method="post" action="{{ url_for('importer.upload') }}" class="mt-3">
  <input type="hidden" name="csv_text" value="{{ csv_text }}">
  <input type="hidden" name="normalized" value="{{ normalized | tojson }}">
  <textarea name="mapping" id="mapping" style="display:none;"></textarea>
  <button type="submit" class="btn btn-success">Import</button>
</form>

<script>
  let columns = {{ columns|tojson }};
  let entityCount = 0;
  let relationCount = 0;

  function addEntity() {
    let container = document.getElementById("entities");
    let div = document.createElement("div");
    div.className = "entity-group border rounded p-2 my-2";
    div.innerHTML = `
      <label>Entity Name:
        <input type="text" class="form-control" name="entity_${entityCount}_name">
      </label>
      <div class="mt-2">
        <label>Columns:</label><br>
        ${columns.map(c => `
          <label class="me-2">
            <input type="checkbox" name="entity_${entityCount}_cols" value="${c}"> ${c}
          </label>`).join("")}
      </div>
      <div class="mt-2">
        <label>Primary Key:
          <select name="entity_${entityCount}_pk" class="form-select form-select-sm">
            <option value="">-- select --</option>
            ${columns.map(c => `<option value="${c}">${c}</option>`).join("")}
          </select>
        </label>
      </div>
    `;
    container.appendChild(div);
    entityCount++;
  }

  function addRelation() {
    let container = document.getElementById("relations");
    let div = document.createElement("div");
    div.className = "relation-row my-2";
    div.innerHTML = `
      <label class="me-2">From Entity:
        <input type="text" class="form-control d-inline-block w-auto" name="relation_${relationCount}_from">
      </label>
      <label class="me-2">Relation Type:
        <input type="text" class="form-control d-inline-block w-auto" name="relation_${relationCount}_type">
      </label>
      <label class="me-2">To Entity:
        <input type="text" class="form-control d-inline-block w-auto" name="relation_${relationCount}_to">
      </label>
    `;
    container.appendChild(div);
    relationCount++;
  }

  document.querySelector("form").addEventListener("submit", function() {
    let entities = [];
    for (let i=0; i<entityCount; i++) {
      let name = document.querySelector(`[name=entity_${i}_name]`)?.value;
      if (!name) continue;
      let cols = Array.from(document.querySelectorAll(`[name=entity_${i}_cols]:checked`)).map(cb => cb.value);
      let pk = document.querySelector(`[name=entity_${i}_pk]`)?.value;
      entities.push({name, cols, pk});
    }
    let relations = [];
    for (let i=0; i<relationCount; i++) {
      let from = document.querySelector(`[name=relation_${i}_from]`)?.value;
      let type = document.querySelector(`[name=relation_${i}_type]`)?.value;
      let to = document.querySelector(`[name=relation_${i}_to]`)?.value;
      if (from && type && to) relations.push({from, type, to});
    }
    document.getElementById("mapping").value = JSON.stringify({entities, relations});
  });
</script>

{% endblock %}
